---
# Install VS Code - idempotent

# macOS installation via Homebrew cask
- name: Check if VS Code is installed (macOS)
  ansible.builtin.stat:
    path: /Applications/Visual Studio Code.app
  register: vscode_app
  when: ansible_os_family == 'Darwin'

- name: Install VS Code via Homebrew cask (macOS)
  community.general.homebrew_cask:
    name: visual-studio-code
    state: present
  when: ansible_os_family == 'Darwin' and not vscode_app.stat.exists

# Debian/Ubuntu installation
- name: Install VS Code (Debian/Ubuntu)
  when: ansible_os_family == 'Debian'
  become: true
  block:
    - name: Add Microsoft GPG key
      ansible.builtin.get_url:
        url: https://packages.microsoft.com/keys/microsoft.asc
        dest: /etc/apt/keyrings/microsoft.asc
        mode: '0644'

    - name: Add VS Code repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/microsoft.asc] https://packages.microsoft.com/repos/vscode stable main"
        state: present
        filename: vscode

    - name: Install VS Code
      ansible.builtin.apt:
        name: code
        state: present
        update_cache: true

# RHEL/Fedora installation
- name: Install VS Code (RHEL/Fedora)
  when: ansible_os_family == 'RedHat'
  become: true
  block:
    - name: Add VS Code repository
      ansible.builtin.yum_repository:
        name: vscode
        description: Visual Studio Code
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc
        gpgcheck: true
        enabled: true

    - name: Install VS Code
      ansible.builtin.dnf:
        name: code
        state: present

# Install extensions - works on all platforms
- name: Get list of installed extensions
  ansible.builtin.command: code --list-extensions
  register: installed_extensions
  changed_when: false
  failed_when: false

- name: Install VS Code extensions
  ansible.builtin.command: code --install-extension {{ item }}
  loop: "{{ vscode_extensions }}"
  when: item not in installed_extensions.stdout_lines
  register: ext_result
  changed_when: "'was successfully installed' in ext_result.stdout"